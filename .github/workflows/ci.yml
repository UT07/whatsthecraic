name: CI

on:
  push:
    branches: [master, develop]
  pull_request:
    branches: [master]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
      - run: npm ci --ignore-scripts
      - run: npm run lint || true

  test-services:
    name: Test Services
    runs-on: ubuntu-latest
    needs: lint
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: testroot
          MYSQL_DATABASE: gigsdb
          MYSQL_USER: app
          MYSQL_PASSWORD: app
        ports:
          - 3306:3306
        options: >-
          --health-cmd "mysqladmin ping -h localhost -ptestroot"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Initialize database
        run: |
          mysql -h 127.0.0.1 -uroot -ptestroot gigsdb < init-gigsdb.sql
          mysql -h 127.0.0.1 -uroot -ptestroot gigsdb < database/migrations/003_ml_service_tables.sql
        env:
          MYSQL_PWD: testroot

      - name: Test auth-service
        working-directory: auth-service
        run: |
          npm ci --ignore-scripts
          timeout 10 node index.js &
          sleep 3
          curl -sf http://localhost:3001/health | jq .
          kill %1 || true
        env:
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_USER: app
          DB_PASSWORD: app
          DB_NAME: gigsdb
          PORT: 3001
          JWT_SECRET: test-ci-secret

      - name: Test events-service
        working-directory: events-service
        run: |
          npm ci --ignore-scripts
          timeout 10 node index.js &
          sleep 3
          curl -sf http://localhost:4003/health | jq .
          kill %1 || true
        env:
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_USER: app
          DB_PASSWORD: app
          DB_NAME: gigsdb
          API_PORT: 4003
          JWT_SECRET: test-ci-secret
          INGESTION_ENABLED: "false"

      - name: Test venue-service
        working-directory: venue-service
        run: |
          npm ci --ignore-scripts
          timeout 10 node index.js &
          sleep 3
          curl -sf http://localhost:4001/health | jq .
          kill %1 || true
        env:
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_USER: app
          DB_PASSWORD: app
          DB_NAME: gigsdb
          API_PORT: 4001

      - name: Test dj-service
        working-directory: dj-service
        run: |
          npm ci --ignore-scripts
          timeout 10 node index.js &
          sleep 3
          curl -sf http://localhost:4002/health | jq .
          kill %1 || true
        env:
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_USER: app
          DB_PASSWORD: app
          DB_NAME: gigsdb
          API_PORT: 4002

  test-ml-service:
    name: Test ML Service
    runs-on: ubuntu-latest
    needs: lint
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: testroot
          MYSQL_DATABASE: gigsdb
          MYSQL_USER: app
          MYSQL_PASSWORD: app
        ports:
          - 3306:3306
        options: >-
          --health-cmd "mysqladmin ping -h localhost -ptestroot"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install ML dependencies
        run: pip install -r ml-service/requirements.txt

      - name: Initialize database
        run: |
          mysql -h 127.0.0.1 -uroot -ptestroot gigsdb < init-gigsdb.sql
          mysql -h 127.0.0.1 -uroot -ptestroot gigsdb < database/migrations/003_ml_service_tables.sql

      - name: Test ML service starts
        run: |
          cd ml-service
          timeout 15 uvicorn src.main:app --host 0.0.0.0 --port 4004 &
          sleep 5
          curl -sf http://localhost:4004/health | jq .
          kill %1 || true
        env:
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_USER: app
          DB_PASSWORD: app
          DB_NAME: gigsdb
          ENABLE_CLOUDWATCH: "false"
          USE_LOCAL_DYNAMODB: "true"
          ENVIRONMENT: test

  test-frontend:
    name: Test Frontend Build
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 18
      - name: Install frontend deps
        working-directory: gigfinder-app
        run: npm ci --legacy-peer-deps
      - name: Build frontend
        working-directory: gigfinder-app
        run: NODE_OPTIONS="--openssl-legacy-provider" npm run build
        env:
          CI: "false"

  docker-compose-smoke:
    name: Docker Compose Smoke Test
    runs-on: ubuntu-latest
    needs: [test-services, test-ml-service, test-frontend]
    steps:
      - uses: actions/checkout@v4

      - name: Create test .env
        run: |
          cat > .env << 'ENVEOF'
          DB_HOST=db
          DB_PORT=3306
          DB_USER=app
          DB_PASSWORD=app
          DB_NAME=gigsdb
          JWT_SECRET=ci-test-secret
          AGGREGATOR_PORT=4000
          AUTH_SERVICE_PORT=3001
          EVENTS_SERVICE_PORT=4003
          DJ_SERVICE_PORT=4002
          VENUE_SERVICE_PORT=4001
          ML_SERVICE_PORT=4004
          VENUE_SERVICE_URL=http://venue-service:4001
          DJ_SERVICE_URL=http://dj-service:4002
          LOCAL_EVENTS_URL=http://events-service:4003
          ML_SERVICE_URL=http://ml-service:4004
          INGESTION_ENABLED=false
          ENABLE_CLOUDWATCH=false
          USE_LOCAL_DYNAMODB=true
          AWS_REGION=eu-west-1
          ENVIRONMENT=test
          ENVEOF

      - name: Start all services
        run: docker compose up -d --build --wait --wait-timeout 120

      - name: Check service health
        run: |
          echo "=== Service Status ==="
          docker compose ps
          echo ""
          echo "=== Health Checks ==="
          for port in 3001 4001 4002 4003 4004 4000; do
            echo -n "Port $port: "
            curl -sf http://localhost:$port/health | jq -r '.status // .service // "ok"' || echo "FAILED"
          done

      - name: API smoke tests
        run: |
          echo "--- Register user ---"
          curl -sf -X POST http://localhost:4000/v1/auth/signup \
            -H 'Content-Type: application/json' \
            -d '{"email":"ci@test.com","password":"Test1234!","name":"CI User"}' | jq .

          echo "--- Login ---"
          TOKEN=$(curl -sf -X POST http://localhost:4000/v1/auth/login \
            -H 'Content-Type: application/json' \
            -d '{"email":"ci@test.com","password":"Test1234!"}' | jq -r '.token')
          echo "Got token: ${TOKEN:0:20}..."

          echo "--- Search events ---"
          curl -sf "http://localhost:4000/v1/events/search?limit=5" | jq '.count'

          echo "--- Feed (authed) ---"
          curl -sf "http://localhost:4000/v1/users/me/feed?limit=5" \
            -H "Authorization: Bearer $TOKEN" | jq '.count'

          echo "--- Performers ---"
          curl -sf "http://localhost:4000/v1/performers?limit=3" | jq '.count'

          echo "--- Venues ---"
          curl -sf "http://localhost:4000/v1/venues?limit=3" | jq '.count // .venues | length'

          echo "--- ML health ---"
          curl -sf http://localhost:4004/health | jq .

          echo "--- ML model info ---"
          curl -sf http://localhost:4004/v1/model/info | jq . || echo "Model not trained yet (expected)"

          echo ""
          echo "All smoke tests passed!"

      - name: Collect logs on failure
        if: failure()
        run: docker compose logs --tail 50

      - name: Cleanup
        if: always()
        run: docker compose down -v
