apiVersion: batch/v1
kind: CronJob
metadata:
  name: ml-retrain-cronjob
  namespace: whatsthecraic
spec:
  # Schedule: Daily at 2 AM UTC
  schedule: "0 2 * * *"

  # Keep last 3 successful and 1 failed job
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1

  # Suspend if needed (set to true to disable)
  suspend: false

  jobTemplate:
    spec:
      # Clean up completed jobs after 1 hour
      ttlSecondsAfterFinished: 3600

      template:
        metadata:
          labels:
            app: ml-retrain-job
            component: ml-service
        spec:
          restartPolicy: OnFailure

          containers:
          - name: retrain-trigger
            image: curlimages/curl:8.5.0
            imagePullPolicy: IfNotPresent

            command:
            - /bin/sh
            - -c
            - |
              echo "Starting ML model retrain at $(date)"

              # Trigger retrain endpoint
              RESPONSE=$(curl -w "\n%{http_code}" -X POST \
                http://ml-service:4004/v1/model/retrain \
                -H "Content-Type: application/json" \
                --max-time 600 \
                -s)

              HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
              BODY=$(echo "$RESPONSE" | sed '$d')

              echo "Response code: $HTTP_CODE"
              echo "Response body: $BODY"

              if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
                echo "Model retrain completed successfully at $(date)"
                exit 0
              else
                echo "Model retrain failed with HTTP code $HTTP_CODE"
                exit 1
              fi

            resources:
              requests:
                memory: "32Mi"
                cpu: "50m"
              limits:
                memory: "64Mi"
                cpu: "100m"

          # Use default service account
          serviceAccountName: default

          # Tolerate node issues
          tolerations:
          - key: "node.kubernetes.io/not-ready"
            operator: "Exists"
            effect: "NoExecute"
            tolerationSeconds: 300
---
# Optional: ServiceMonitor for Prometheus metrics (if using prometheus-operator)
# apiVersion: monitoring.coreos.com/v1
# kind: ServiceMonitor
# metadata:
#   name: ml-retrain-cronjob
#   namespace: whatsthecraic
#   labels:
#     app: ml-retrain-job
# spec:
#   selector:
#     matchLabels:
#       app: ml-retrain-job
#   endpoints:
#   - port: metrics
#     interval: 30s
